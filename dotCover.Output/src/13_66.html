<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>/home/runner/work/Html2Markdown/Html2Markdown/src/Html2Markdown/Converter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.IO;
using System.Text.RegularExpressions;
using Html2Markdown.Replacement;
using Html2Markdown.Scheme;

namespace Html2Markdown;

/// &lt;summary&gt;
/// An Html to Markdown converter.
/// &lt;/summary&gt;
public partial class Converter
{
	private readonly IList&lt;IReplacer&gt; _replacers;
		
	/// &lt;summary&gt;
	/// Create a Converter with the standard Markdown conversion scheme
	/// &lt;/summary&gt;
	public Converter() 
	{
		_replacers = new Markdown().Replacers();
	}

	/// &lt;summary&gt;
	/// Create a converter with a custom conversion scheme
	/// &lt;/summary&gt;
	/// &lt;param name=&quot;scheme&quot;&gt;Conversion scheme to control conversion&lt;/param&gt;
	public Converter(IScheme scheme)
	{
		_replacers = scheme.Replacers();
	}

	/// &lt;summary&gt;
	/// Converts Html contained in a file to a Markdown string
	/// &lt;/summary&gt;
	/// &lt;param name=&quot;path&quot;&gt;The path to the file which is being converted&lt;/param&gt;
	/// &lt;returns&gt;A Markdown representation of the passed in Html&lt;/returns&gt;
	public string ConvertFile(string path)
	{
		using var stream = new FileStream(path, FileMode.Open);
		using var reader = new StreamReader(stream);
		var html = reader.ReadToEnd();
		html = StandardiseWhitespace(html);
		return Convert(html);
	}

	private static string StandardiseWhitespace(string html)
	{
		return MatchCarriageReturn().Replace(html, &quot;$1\r\n&quot;);
	}

	/// &lt;summary&gt;
	/// Converts an Html string to a Markdown string
	/// &lt;/summary&gt;
	/// &lt;param name=&quot;html&quot;&gt;The Html string you wish to convert&lt;/param&gt;
	/// &lt;returns&gt;A Markdown representation of the passed in Html&lt;/returns&gt;
	public string Convert(string html)
	{
		return CleanWhiteSpace(_replacers.Aggregate(html, (current, element) =&gt; element.Replace(current)));
	}

	private static string CleanWhiteSpace(string markdown)
	{
		var cleaned = MatchCarriageReturnsWithSpacesInBetween().Replace(markdown, Environment.NewLine + Environment.NewLine);
		cleaned = MatchThreeCarriageReturns().Replace(cleaned, Environment.NewLine + Environment.NewLine);
		cleaned = MatchBlockQuotes().Replace(cleaned, &quot;&gt; &quot; + Environment.NewLine + Environment.NewLine);
		cleaned = MatchCarriageReturnsAtTheBeginning().Replace(cleaned, &quot;&quot;);
		cleaned = MatchCarriageReturnsAtTheEnd().Replace(cleaned, &quot;&quot;);
		return cleaned.Trim();
	}

    [GeneratedRegex(@&quot;([^\r])\n&quot;)]
    private static partial Regex MatchCarriageReturn();
    [GeneratedRegex(@&quot;\r?\n\s+\r?\n&quot;)]
    private static partial Regex MatchCarriageReturnsWithSpacesInBetween();
    [GeneratedRegex(@&quot;(\r?\n){3,}&quot;)]
    private static partial Regex MatchThreeCarriageReturns();
    [GeneratedRegex(@&quot;(&gt; \r?\n){2,}&quot;)]
    private static partial Regex MatchBlockQuotes();
    [GeneratedRegex(@&quot;^(\r?\n)+&quot;)]
    private static partial Regex MatchCarriageReturnsAtTheBeginning();
    [GeneratedRegex(@&quot;(\r?\n)+$&quot;)]
    private static partial Regex MatchCarriageReturnsAtTheEnd();
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,2,18,20,1],[19,2,19,3,1],[20,3,20,43,1],[21,2,21,3,1],[27,2,27,34,1],[28,2,28,3,1],[29,3,29,35,1],[30,2,30,3,1],[38,2,38,3,1],[39,3,39,58,1],[40,3,40,47,0],[41,3,41,33,0],[42,3,42,38,0],[43,3,43,24,0],[44,2,44,3,0],[47,2,47,3,0],[48,3,48,56,0],[49,2,49,3,0],[57,2,57,3,1],[58,3,58,75,1],[58,75,58,99,1],[58,99,58,102,1],[59,2,59,3,1],[62,2,62,3,1],[63,3,63,120,1],[64,3,64,101,1],[65,3,65,99,1],[66,3,66,71,1],[67,3,67,65,1],[68,3,68,25,1],[69,2,69,3,1]]);
    </script>
  </body>
</html>